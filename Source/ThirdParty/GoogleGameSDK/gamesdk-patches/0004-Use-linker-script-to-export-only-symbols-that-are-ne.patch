From ae3c0b74f674ac31bae1a97274e93d16d8663831 Mon Sep 17 00:00:00 2001
From: Florian Penzkofer <florian.penzkofer@epicgames.com>
Date: Thu, 29 Aug 2024 10:15:39 -0500
Subject: [PATCH 4/7] Use linker script to export only symbols that are needed

---
 games-frame-pacing/CMakeLists.txt |  9 ++++-
 games-frame-pacing/exports.lds    | 63 +++++++++++++++++++++++++++++++
 2 files changed, 70 insertions(+), 2 deletions(-)
 create mode 100644 games-frame-pacing/exports.lds

diff --git a/games-frame-pacing/CMakeLists.txt b/games-frame-pacing/CMakeLists.txt
index 3445fa9a..0f8fba15 100644
--- a/games-frame-pacing/CMakeLists.txt
+++ b/games-frame-pacing/CMakeLists.txt
@@ -4,7 +4,9 @@ set(CMAKE_CXX_STANDARD 17)
 set(IgnoreOldToolchainWarning "${ANDROID_UNIFIED_HEADERS}")
 
 set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++17 -Wall -Werror -Wthread-safety" )
-set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -D _LIBCPP_ENABLE_THREAD_SAFETY_ANNOTATIONS -O3 -fPIC" )
+set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -D _LIBCPP_ENABLE_THREAD_SAFETY_ANNOTATIONS -fPIC" )
+set( CMAKE_CXX_FLAGS_RELWITHDEBINFO "${CMAKE_CXX_FLAGS_RELWITHDEBINFO} -O3" )
+set( CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -Og" )
 set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fno-exceptions" )
 set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fno-rtti" )
 set( CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -ffunction-sections -fdata-sections" )
@@ -14,8 +16,9 @@ if ( DEFINED GAMESDK_THREAD_CHECKS )
 endif()
 
 set( CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--gc-sections" )
-set( CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,-s" )
 set( CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--hash-style=both" )
+set( CMAKE_SHARED_LINKER_FLAGS_RELWITHDEBINFO "${CMAKE_SHARED_LINKER_FLAGS_RELWITHDEBINFO} -Wl,-s" )
+set( CMAKE_SHARED_LINKER_FLAGS_RELWITHDEBINFO "${CMAKE_SHARED_LINKER_FLAGS_RELWITHDEBINFO} -Wl,--version-script=${CMAKE_CURRENT_SOURCE_DIR}/exports.lds" )
 
 set ( SOURCE_LOCATION .)
 set ( SOURCE_LOCATION_COMMON "${SOURCE_LOCATION}/common" )
@@ -108,6 +111,8 @@ add_library( swappy
              ${SOURCE_LOCATION_VULKAN}/swappyVk_c.cpp)
 
 
+set_target_properties(swappy PROPERTIES LINK_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/exports.lds)
+
 target_link_libraries( swappy
 
                         swappy_static
diff --git a/games-frame-pacing/exports.lds b/games-frame-pacing/exports.lds
new file mode 100644
index 00000000..58adee3f
--- /dev/null
+++ b/games-frame-pacing/exports.lds
@@ -0,0 +1,63 @@
+{
+  global:
+    Java_com_google_androidgamesdk_ChoreographerCallback_nOnChoreographer;
+    Java_com_google_androidgamesdk_SwappyDisplayManager_nOnRefreshPeriodChanged;
+    Java_com_google_androidgamesdk_SwappyDisplayManager_nSetSupportedRefreshPeriods;
+    SwappyVk_determineDeviceExtensions;
+    SwappyVk_setQueueFamilyIndex;
+    SwappyVk_initAndGetRefreshCycleDuration;
+    SwappyVk_setWindow;
+    SwappyVk_setSwapIntervalNS;
+    SwappyVk_queuePresent;
+    SwappyVk_destroySwapchain;
+    SwappyVk_destroyDevice;
+    SwappyVk_setAutoSwapInterval;
+    SwappyVk_setAutoPipelineMode;
+    SwappyVk_setMaxAutoSwapIntervalNS;
+    SwappyVk_setFenceTimeoutNS;
+    SwappyVk_getFenceTimeoutNS;
+    SwappyVk_injectTracer;
+    SwappyVk_setFunctionProvider;
+    SwappyVk_getSwapIntervalNS;
+    SwappyVk_getSupportedRefreshPeriodsNS;
+    SwappyVk_isEnabled;
+    SwappyVk_enableStats;
+    SwappyVk_recordFrameStart;
+    SwappyVk_getStats;
+    SwappyVk_uninjectTracer;
+    SwappyVk_clearStats;
+    SwappyVk_resetFramePacing;
+    SwappyVk_enableFramePacing;
+    SwappyVk_enableBlockingWait;
+    SwappyGL_init;
+    SwappyGL_isEnabled;
+    SwappyGL_destroy;
+    SwappyGL_setWindow;
+    SwappyGL_swap;
+    SwappyGL_setUseAffinity;
+    SwappyGL_setSwapIntervalNS;
+    SwappyGL_setFenceTimeoutNS;
+    SwappyGL_getRefreshPeriodNanos;
+    SwappyGL_getSwapIntervalNS;
+    SwappyGL_getUseAffinity;
+    SwappyGL_getFenceTimeoutNS;
+    SwappyGL_setBufferStuffingFixWait;
+    SwappyGL_getSupportedRefreshPeriodsNS;
+    SwappyGL_onChoreographer;
+    SwappyGL_injectTracer;
+    SwappyGL_setAutoSwapInterval;
+    SwappyGL_setMaxAutoSwapIntervalNS;
+    SwappyGL_setAutoPipelineMode;
+    SwappyGL_enableStats;
+    SwappyGL_recordFrameStart;
+    SwappyGL_getStats;
+    SwappyGL_uninjectTracer;
+    SwappyGL_clearStats;
+    SwappyGL_resetFramePacing;
+    SwappyGL_enableFramePacing;
+    SwappyGL_enableBlockingWait;
+    Swappy_version;
+    Swappy_setThreadFunctions;
+    Swappy_versionString;
+  local: *;
+};
\ No newline at end of file
-- 
2.41.0.windows.3

